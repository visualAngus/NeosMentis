<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeosMentis - Agenda</title>

    <link rel="icon" href="/logo/logo_B.png">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/agenda.css">
    <link rel="stylesheet" href="css/agenda_adap.css">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">

</head>

<body>
    <header>
        <div class="div_param_acc_tel">
            <div class="ligne"></div>
            <div class="ligne"></div>
            <div class="ligne"></div>
        </div>
        <div class="div_acces_header">
            <div class="div_home_bnt">
                <a href="/">Home</a>
                <a href="/project">Project</a>
            </div>
        </div>
        <div class="div_center_header">
            <img src="/logo/logo_B.png" alt="logo">
            <h1>
                NeosMentis
            </h1>
        </div>
        <div class="div_compte_header">
            <div class="div_profil_bnt">
                <a href="/log?type=log">Login</a>
                <a href="/log?type=register">Register</a>
            </div>
        </div>
    </header>
    <main>
        <div class="agenda">
            <div class="div_control">
                <div class="date-picker-container">
                    <button id="prev-day">
                        <svg width="20" height="20" viewBox="0 0 20 20">
                            <path d="M15 10L5 10M5 10L10 15M5 10L10 5" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                    </button>
                    <input type="date" id="date-picker" class="date-picker">
                    <button id="next-day">
                        <svg width="20" height="20" viewBox="0 0 20 20">
                            <path d="M5 10L15 10M15 10L10 5M15 10L10 15" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                    </button>

                    <div class="btn_ajd">
                        <h4>Aujourd'hui</h4>
                    </div>
                </div>
            </div>
            <div class="div_jours">
                <div class="div_jour_nom">
                    <h4>Lundi</h4>
                </div>
                <div class="div_jour_nom">
                    <h4>Mardi</h4>
                </div>
                <div class="div_jour_nom">
                    <h4>Mercredi</h4>
                </div>
                <div class="div_jour_nom">
                    <h4>Jeudi</h4>
                </div>
                <div class="div_jour_nom">
                    <h4>Vendredi</h4>
                </div>
                <div class="div_jour_nom">
                    <h4>Samedi</h4>
                </div>
                <div class="div_jour_nom">
                    <h4>Dimanche</h4>
                </div>
            </div>
            <div class="div_agenda_ctrl">
                <div class="div_heures">
                    <div class="div_heure non">
                        <p>00:00</p>
                    </div>
                    <div class="div_heure">
                        <p>01:00</p>
                    </div>
                    <div class="div_heure">
                        <p>02:00</p>
                    </div>
                    <div class="div_heure">
                        <p>03:00</p>
                    </div>
                    <div class="div_heure">
                        <p>04:00</p>
                    </div>
                    <div class="div_heure">
                        <p>05:00</p>
                    </div>
                    <div class="div_heure">
                        <p>06:00</p>
                    </div>
                    <div class="div_heure">
                        <p>07:00</p>
                    </div>
                    <div class="div_heure">
                        <p>08:00</p>
                    </div>
                    <div class="div_heure">
                        <p>09:00</p>
                    </div>
                    <div class="div_heure">
                        <p>10:00</p>
                    </div>
                    <div class="div_heure">
                        <p>11:00</p>
                    </div>
                    <div class="div_heure">
                        <p>12:00</p>
                    </div>
                    <div class="div_heure">
                        <p>13:00</p>
                    </div>
                    <div class="div_heure">
                        <p>14:00</p>
                    </div>
                    <div class="div_heure">
                        <p>15:00</p>
                    </div>
                    <div class="div_heure">
                        <p>16:00</p>
                    </div>
                    <div class="div_heure">
                        <p>17:00</p>
                    </div>
                    <div class="div_heure">
                        <p>18:00</p>
                    </div>
                    <div class="div_heure">
                        <p>19:00</p>
                    </div>
                    <div class="div_heure">
                        <p>20:00</p>
                    </div>
                    <div class="div_heure">
                        <p>21:00</p>
                    </div>
                    <div class="div_heure">
                        <p>22:00</p>
                    </div>
                    <div class="div_heure">
                        <p>23:00</p>
                    </div>
                </div>
                <div class="div_agenda">
                    <div class="div_jour" id="0"></div>
                    <div class="div_jour" id="1"></div>
                    <div class="div_jour" id="2"></div>
                    <div class="div_jour" id="3"></div>
                    <div class="div_jour" id="4"></div>
                    <div class="div_jour" id="5"></div>
                    <div class="div_jour" id="6"></div>
                </div>
            </div>
        </div>
    </main>
    <div class="div_popup">
        <!-- <div class="div_illustration">

        </div>
        <div class="div_title_event_pop">
            <div class="div_color_parent">
                <div class="div_color">

                </div>
            </div>
            <div class="div_title_info_parent">
                <h3 id="titre_event_pop" contenteditable="true">Coiffeur</h3>
                <p id="heure_event_pop">Lundi 12:00 - 13:00</p>
            </div>
        </div>
        <div class="div_description_parent_pop">
            <div class="description_pop">
                <h4>Description: </h4>
                <p id="description_event_pop">Lorem ipsum dolor sit ametLorem ipsum dolor sit ametLorem ipsum dolor sit
                    ametLorem ipsum dolor sit ametLorem ipsum dolor sit ametLorem ipsum dolor sit amet consectetur
                    adipisicing elit. Quisquam, quod.</p>
            </div>
            <div class="localistion_pop">
                <h4>Localisation: </h4>
                <p id="localisation_event_pop">Salle A101</p>
            </div>
            <div class="groupe_pop">
                <h4>Groupe: </h4>
                <p id="groupe_event_pop">Coiffeur</p>
            </div>

        </div>
        <div class="div_link_and_document_parent_pop">
            <div class="document_link_pop">
                <a href="#">Document 1</a>
            </div>
            <div class="link_pop">
                <a href="#">Lien 1</a>
            </div>
        </div>
    <!-- </div> -->
</body>
<script type="module">
    import { format, addDays, parseISO, differenceInDays } from 'https://cdn.jsdelivr.net/npm/date-fns@2.30.0/+esm';

    const datePicker = document.getElementById("date-picker");
    const prevDayButton = document.getElementById("prev-day");
    const nextDayButton = document.getElementById("next-day");
    const formattedDate = document.getElementById("formatted-date");
    const btn_ajd = document.querySelector(".btn_ajd");


    function close_event() {
        let last_popup = document.querySelector('.div_popup');
        if (last_popup) {
            last_popup.remove();
        }
    }
    function close_event_div_add_event() {
        let last_popup = document.querySelector('.div_popup_add_event');
        if (last_popup) {
            last_popup.remove();
        }
    }

    function createPopupDiv(eventData, day) {
        close_event_div_add_event();
        let last_popup = document.querySelector('.div_popup');
        if (last_popup) {
            last_popup.remove();
        }

        let popup = document.createElement('div');
        popup.className = 'div_popup';

        let divIllustration = document.createElement('div');
        divIllustration.className = 'div_illustration';

        let divTitleEvent = document.createElement('div');
        divTitleEvent.className = 'div_title_event_pop';

        let divColorParent = document.createElement('div');
        divColorParent.className = 'div_color_parent';
        let divColor = document.createElement('div');
        divColor.className = 'div_color';
        divColor.style.backgroundColor = eventData.color;
        divColorParent.appendChild(divColor);

        let divTitleInfo = document.createElement('div');
        divTitleInfo.className = 'div_title_info_parent';
        let h3Title = document.createElement('h3');
        h3Title.id = 'titre_event_pop';
        h3Title.contentEditable = 'true';
        h3Title.textContent = eventData.title || 'Titre de l\'évènement';
        let pTime = document.createElement('p');
        pTime.id = 'heure_event_pop';

        let start = get_only_time(eventData.startTime);
        let end = get_only_time(eventData.endTime);
        let jour_nom = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
        let index = new Date(day).getDay();
        let day_nom = jour_nom[index];


        pTime.textContent = `${day_nom} ${start} - ${end}`;

        divTitleInfo.append(h3Title, pTime);

        divTitleEvent.append(divColorParent, divTitleInfo);

        let divDescription = document.createElement('div');
        divDescription.className = 'div_description_parent_pop';

        let descriptionDiv = document.createElement('div');
        descriptionDiv.className = 'description_pop';
        let h4Desc = document.createElement('h4');
        h4Desc.textContent = 'Description: ';
        let pDesc = document.createElement('p');
        pDesc.id = 'description_event_pop';
        pDesc.textContent = eventData.description || 'No description available';
        if (eventData.description) {
            descriptionDiv.append(h4Desc, pDesc);
            divDescription.append(descriptionDiv);
        }

        let locationDiv = document.createElement('div');
        locationDiv.className = 'localistion_pop';
        let h4Loc = document.createElement('h4');
        h4Loc.textContent = 'Localisation: ';
        let pLoc = document.createElement('p');
        pLoc.id = 'localisation_event_pop';
        pLoc.textContent = eventData.location || 'No location specified';
        if (eventData.location) {
            locationDiv.append(h4Loc, pLoc);
            divDescription.append(locationDiv);
        }

        let groupDiv = document.createElement('div');
        groupDiv.className = 'groupe_pop';
        let h4Group = document.createElement('h4');
        h4Group.textContent = 'Groupe: ';
        let pGroup = document.createElement('p');
        pGroup.id = 'groupe_event_pop';
        pGroup.textContent = eventData.group || 'No group specified';
        if (eventData.group) {
            groupDiv.append(h4Group, pGroup);
            divDescription.append(groupDiv);
        }

        let divLinks = document.createElement('div');
        divLinks.className = 'div_link_and_document_parent_pop';

        for (let i = 0; i < eventData.linkedItems.notes.length; i++) {
            let docLink = document.createElement('div');
            docLink.className = 'document_link_pop';
            let aDoc = document.createElement('a');
            aDoc.href = '#' + eventData.linkedItems.notes[i];
            aDoc.textContent = `Document ${i + 1}`;
            docLink.appendChild(aDoc);
            divLinks.appendChild(docLink);
        }

        for (let i = 0; i < eventData.linkedItems.sections.length; i++) {
            let linkDiv = document.createElement('div');
            linkDiv.className = 'link_pop';
            let aLink = document.createElement('a');
            aLink.href = '#' + eventData.linkedItems.sections[i];
            aLink.textContent = `Lien ${i + 1}`;
            linkDiv.appendChild(aLink);
            divLinks.appendChild(linkDiv);
        }

        let btn_add = document.createElement('button');
        btn_add.className = 'btn_add';
        btn_add.textContent = 'Supprimer';

        btn_add.addEventListener("click", () => {
            let id = eventData.id;
            // enlever les 2 premiers caractères
            id = id.slice(2);
            fetch('agenda/delete_agenda_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id })
            }).then(res => {
                if (res.status == 200) {
                    close_event();
                    updateFormattedDate();
                }
            });
        });

        divLinks.appendChild(btn_add);
        popup.append(divIllustration, divTitleEvent, divDescription, divLinks);

        return popup;
    }

    function addEvent(id, name, start, end, overlap_count, index, color, data, day) {
        let event = document.createElement("div");

        let titre = document.createElement("h3");
        titre.innerHTML = name;
        titre.className = "titre_event";

        let heure = document.createElement("p");
        let start_time = get_only_time(data.startTime);
        let end_time = get_only_time(data.startTime);

        console.log(start_time, end_time);
        heure.innerHTML = `${start_time} - ${end_time}`;
        heure.className = "heure_event";


        event.id = id;
        event.className = "div_event";
        event.style.backgroundColor = color;
        event.style.height = `calc((${end} - ${start}) * 40px)`;
        event.style.top = `calc(${start} * 40px)`;
        event.style.left = `calc((100% / ${overlap_count}) * ${index} - ${(index + 1) * 2.5}px)`;
        event.style.width = `calc(100% / ${overlap_count} - 2.5px)`;

        event.setAttribute("data", [start, end, overlap_count, index].join(","));

        event.appendChild(titre);
        event.appendChild(heure);

        event.addEventListener("click", (e) => {
            let pop = createPopupDiv(data, day);
            document.body.appendChild(pop);
            pop.style.display = 'flex';

            let event_posi = event.getBoundingClientRect();
            let pop_posi = pop.getBoundingClientRect();
            if (event_posi.top + pop_posi.height + event_posi.height > window.innerHeight - 200) {
                pop.style.top = `${event_posi.top - pop_posi.height}px`;
            } else {
                pop.style.top = `${event_posi.bottom}px`;
            }


            if (event_posi.left + event_posi.width + pop_posi.width > window.innerWidth) {
                pop.style.left = `${event_posi.left - pop_posi.width}px`;
            } else {
                pop.style.left = `${event_posi.right}px`;
            }

        });
        event.addEventListener("dblclick", () => {
            close_event(event);
        });


        return event;
    }

    function convert_hours_to_int(hours) {
        let [hour, minute] = hours.split(":");
        return parseInt(hour) + parseInt(minute) / 60;
    }

    function get_only_date(date) {
        return date.split("T")[0];
    }

    function get_only_time(date) {
        return date.split("T")[1].split(":").slice(0,2).join(":");
    }

    function convert_hours_into_int_from_date(date) {
        let [hour, minute] = date.split(":");
        return parseInt(hour) + parseInt(minute) / 60;
    }

    function convert_int_to_hours(int_hour) {
        return int_hour.toString().padStart(2, '0') + ':00';
    }

    function clean_agenda() {
        let day_week_div = document.getElementsByClassName("div_jour");
        for (let i = 0; i < day_week_div.length; i++) {
            day_week_div[i].innerHTML = "";
        }
        let div_jour_nom = document.getElementsByClassName("div_jour_nom");
        for (let i = 0; i < div_jour_nom.length; i++) {
            // remove only p element
            div_jour_nom[i].querySelectorAll("p").forEach(e => e.remove());

        }
    }

    function add_cursor_of_the_hours() {
        // supprimer les div_heures	
        let div_heures = document.getElementsByClassName("div_cursor");
        for (let i = 0; i < div_heures.length; i++) {
            div_heures[i].remove();
        }

        let div = document.createElement("div");
        div.className = "div_cursor";

        function updatePosition() {
            let date = new Date();
            let hour = date.getHours();
            let minute = date.getMinutes();
            let start = hour + minute / 60;
            div.style.top = `calc(${start} * 40px)`;
        }

        // Initial position
        updatePosition();

        // Update position every minute
        setInterval(updatePosition, 60000);

        return div;
    }

    function open_add_event_popup(day, start, end) {
        close_event_div_add_event();
        close_event();

        let popup = document.createElement('div');
        popup.className = 'div_popup_add_event';

        let divIllustration = document.createElement('div');
        divIllustration.className = 'div_illustration';

        let divTitleEvent = document.createElement('div');
        divTitleEvent.className = 'div_title_event_pop';

        let divColorParent = document.createElement('div');
        divColorParent.className = 'div_color_parent';
        let divColor = document.createElement('div');
        divColor.className = 'div_color';
        divColor.style.backgroundColor = "red";
        divColorParent.appendChild(divColor);

        let divTitleInfo = document.createElement('div');
        divTitleInfo.className = 'div_title_info_parent';
        let h3Title = document.createElement('input');
        h3Title.id = 'titre_event_pop_add';
        h3Title.type = 'text';
        h3Title.placeholder = 'Titre de l\'évènement';

        let parent_time = document.createElement('div');
        parent_time.className = 'parent_time_start';

        let span = document.createElement('span');
        span.textContent = 'Start : ';
        span.id = 'date_heure_event_pop_add';

        let inputDate_start = document.createElement('input');
        inputDate_start.type = 'date';
        inputDate_start.width = '20%';
        inputDate_start.id = 'date_event_pop_add';
        inputDate_start.value = day;

        let inputTime_start = document.createElement('input');
        inputTime_start.type = 'time';
        inputTime_start.width = '20%';
        inputTime_start.id = 'heure_event_pop_add';
        inputTime_start.value = start;

        parent_time.appendChild(span);
        parent_time.appendChild(inputDate_start);
        parent_time.appendChild(inputTime_start);

        divTitleInfo.append(h3Title, parent_time);


        parent_time = document.createElement('div');
        parent_time.className = 'parent_time_end';

        span = document.createElement('span');
        span.textContent = 'End : ';
        span.id = 'date_heure_event_pop_add';

        let inputDate_end = document.createElement('input');
        inputDate_end.type = 'date';
        inputDate_end.width = '20%';
        inputDate_end.id = 'date_event_pop_add';
        inputDate_end.value = day;

        let inputTime_end = document.createElement('input');
        inputTime_end.type = 'time';
        inputTime_end.width = '20%';
        inputTime_end.id = 'heure_event_pop_add';
        inputTime_end.value = end;

        parent_time.appendChild(span);
        parent_time.appendChild(inputDate_end);
        parent_time.appendChild(inputTime_end);


        divTitleInfo.append(parent_time);

        divTitleEvent.append(divColorParent, divTitleInfo);

        let divDescription = document.createElement('div');
        divDescription.className = 'div_description_parent_pop';

        let descriptionDiv = document.createElement('div');
        descriptionDiv.className = 'description_pop';
        let h4Desc = document.createElement('h4');
        h4Desc.textContent = 'Description: ';
        let pDesc = document.createElement('input');
        pDesc.id = 'description_event_pop_add';
        pDesc.type = 'text';
        pDesc.placeholder = 'Description...';
        descriptionDiv.append(h4Desc, pDesc);
        divDescription.append(descriptionDiv);

        let locationDiv = document.createElement('div');
        locationDiv.className = 'localistion_pop';
        let h4Loc = document.createElement('h4');
        h4Loc.textContent = 'Localisation: ';
        let pLoc = document.createElement('input');
        pLoc.id = 'localisation_event_pop_add';
        pLoc.type = 'text';
        pLoc.placeholder = 'Localisation...';
        locationDiv.append(h4Loc, pLoc);
        divDescription.append(locationDiv);

        let groupDiv = document.createElement('div');
        groupDiv.className = 'groupe_pop';
        let h4Group = document.createElement('h4');
        h4Group.textContent = 'Groupe: ';
        let pGroup = document.createElement('select');
        pGroup.id = 'groupe_event_pop_add';

        let option = document.createElement('option');
        option.value = 'Maths';
        option.textContent = 'Maths';
        pGroup.appendChild(option);

        option = document.createElement('option');
        option.value = 'Philo';
        option.textContent = 'Philo';
        pGroup.appendChild(option);



        groupDiv.append(h4Group, pGroup);
        divDescription.append(groupDiv);

        let divLinks = document.createElement('div');
        divLinks.className = 'div_link_and_document_parent_pop';

        // for (let i = 0; i < eventData.linkedItems.notes.length; i++) {
        //     let docLink = document.createElement('div');
        //     docLink.className = 'document_link_pop';
        //     let aDoc = document.createElement('a');
        //     aDoc.href = '#' + eventData.linkedItems.notes[i];
        //     aDoc.textContent = `Document ${i + 1}`;
        //     docLink.appendChild(aDoc);
        //     divLinks.appendChild(docLink);
        // }

        // for (let i = 0; i < eventData.linkedItems.sections.length; i++) {
        //     let linkDiv = document.createElement('div');
        //     linkDiv.className = 'link_pop';
        //     let aLink = document.createElement('a');
        //     aLink.href = '#'+eventData.linkedItems.sections[i];
        //     aLink.textContent = `Lien ${i + 1}`;
        //     linkDiv.appendChild(aLink);
        //     divLinks.appendChild(linkDiv);
        // }

        let btn_add = document.createElement('button');
        btn_add.className = 'btn_add';
        btn_add.textContent = 'Ajouter';

        btn_add.addEventListener("click", () => {
            let id = "";
            let title = h3Title.value;
            let description = pDesc.value;
            let location = pLoc.value;
            let group = pGroup.value;


            let startDate = inputDate_start.value + 'T' + inputTime_start.value;
            let endDate = inputDate_end.value + 'T' + inputTime_end.value;
            let linkedItems = {
                notes: [],
                sections: []
            };
            let color = 'red';

            let data = {
                id,
                title,
                description,
                location,
                group,
                startDate,
                endDate,
                linkedItems,
                color
            };
            add_new_event_base(data).then(res => {
                if (res.status == 200) {
                    close_event_div_add_event();
                    updateFormattedDate();
                }
            });


        });

        divLinks.appendChild(btn_add);


        popup.append(divIllustration, divTitleEvent, divDescription, divLinks);
        return popup;
    }

    async function add_new_event_base(data) {
        return await fetch('agenda/save_agenda_event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
    }

    function load_agenda_week(any_date_from_the_week, json_struc) {
        clean_agenda();

        // get url params
        let urlParams = new URLSearchParams(window.location.search);
        let search_params = urlParams.get('date');
        if (search_params) {
            console.log(search_params);
            any_date_from_the_week = search_params;
            datePicker.value = any_date_from_the_week;
            // remove the param from the url mais garder la page
            window.history.pushState({}, document.title, window.location.pathname);
        }

        any_date_from_the_week = parseISO(any_date_from_the_week);
        let data_day = format(any_date_from_the_week, 'yyyy-MM-dd');

        let data_monday_of_the_week = addDays(any_date_from_the_week, - ((any_date_from_the_week.getDay() + 6) % 7));
        data_monday_of_the_week = format(data_monday_of_the_week, 'yyyy-MM-dd');

        let day_week_div = document.getElementsByClassName("div_jour");
        let div_jour_nom = document.getElementsByClassName("div_jour_nom");
        for (let i = 0; i < day_week_div.length; i++) {
            let day = addDays(parseISO(data_monday_of_the_week), i);
            day = format(day, 'yyyy-MM-dd');
            day_week_div[i].setAttribute("date", day);
            let p = document.createElement("p");
            p.innerHTML = format(parseISO(day), 'dd/MM/yyyy');
            div_jour_nom[i].appendChild(p);

            day_week_div[i].style.backgroundColor = "rgba(0, 0, 0, 0.0)";

            if (day == data_day) {
                day_week_div[i].style.backgroundColor = "rgba(0, 0, 0, 0.1)";
            }
            day_week_div[i].addEventListener("mousemove", (e) => {
                if (document.querySelector(".div_popup_add_event")) {
                    return;
                }

                let y_pos = day_week_div[i].getBoundingClientRect().top;

                let cursor_posi = e.clientY;
                let cursor_posi_relative = cursor_posi - y_pos;
                let cursor_posi_relative_hour = cursor_posi_relative / 40;
                let cursor_posi_relative_hour_round = Math.round(cursor_posi_relative_hour);
                let cursor_posi_relative_hour_round_int = Math.floor(cursor_posi_relative_hour);
                cursor_posi_relative_hour = cursor_posi_relative_hour_round_int * 40

                let hours = convert_int_to_hours(cursor_posi_relative_hour_round_int);
                let hours_plus = convert_int_to_hours(cursor_posi_relative_hour_round_int + 1);

                let div_add_event_ = document.querySelector(".div_add_event");
                if (div_add_event_) {
                    div_add_event_.remove();
                }
                let div_add_event = document.createElement("div");
                div_add_event.className = "div_add_event";
                div_add_event.style.top = `${cursor_posi_relative_hour}px`;

                div_add_event.addEventListener("click", (e) => {
                    let pop = open_add_event_popup(day, hours, hours_plus);
                    document.body.appendChild(pop);
                    pop.style.display = 'flex';
                    pop.style.left = `${e.clientX}px`;

                    let event_posi = div_add_event.getBoundingClientRect();
                    let pop_posi = pop.getBoundingClientRect();

                    if (event_posi.top + pop_posi.height + event_posi.height > window.innerHeight - 200) {
                        pop.style.top = `${event_posi.top - pop_posi.height}px`;
                    } else {
                        pop.style.top = `${event_posi.bottom}px`;
                    }


                    if (event_posi.left + event_posi.width + pop_posi.width > window.innerWidth) {
                        pop.style.left = `${event_posi.left - pop_posi.width}px`;
                    } else {
                        pop.style.left = `${event_posi.right}px`;
                    }

                });
                div_add_event.addEventListener("dblclick", () => {
                    close_event_div_add_event();
                });


                day_week_div[i].appendChild(div_add_event);

            });
            let data = json_struc[day];
            if (data == undefined) {
                continue;
            }
            // document.getElementById("2").appendChild(addEvent("e4", "Event 1", 2, 10, 1, 0, "red"));
            let index = 0;
            data.forEach(event => {
                // verifier si si il se cheuvoche avec 1 ou plusiuer autres evènement de la meme journée

                let overlapping_events = [];

                // Check each event against the current one for overlap
                let current_start = convert_hours_into_int_from_date(get_only_time(event.startTime));
                let current_end = convert_hours_into_int_from_date(get_only_time(event.endTime));
                data.forEach(other_event => {
                    let other_start = convert_hours_into_int_from_date(get_only_time(other_event.startTime));
                    let other_end = convert_hours_into_int_from_date(get_only_time(other_event.endTime));

                    if (current_start < other_end && current_end > other_start) {
                        overlapping_events.push(other_event);
                    }
                });

                let overlap_count = overlapping_events.length || 1;
                index = overlapping_events.indexOf(event);

                let start = convert_hours_into_int_from_date(get_only_time(event.startTime));
                let end = convert_hours_into_int_from_date(get_only_time(event.endTime));

                // let overlap_count = data.length;
                let color = event.color;
                day_week_div[i].appendChild(addEvent(event.id, event.title, start, end, overlap_count, index, color, event, day));
                index++;
            });

        }
        // today
        let today = new Date();
        let todayDay = today.getDay();

        let parent = document.getElementById(todayDay - 1);

        let div_cursor = add_cursor_of_the_hours();
        parent.appendChild(div_cursor);


    }

    // Fonction pour afficher la date formatée
    async function updateFormattedDate() {
        let json_struc = await get_agenda();
        const selectedDate = new Date(datePicker.value);
        load_agenda_week(datePicker.value, json_struc.events);
    }

    // Gérer les clics sur les boutons
    prevDayButton.addEventListener("click", () => {
        const selectedDate = new Date(datePicker.value);
        const newDate = addDays(selectedDate, -1);
        datePicker.value = newDate.toISOString().split("T")[0];
        updateFormattedDate();
    });

    nextDayButton.addEventListener("click", () => {
        const selectedDate = new Date(datePicker.value);
        const newDate = addDays(selectedDate, 1);
        datePicker.value = newDate.toISOString().split("T")[0];
        updateFormattedDate();
    });

    btn_ajd.addEventListener("click", () => {
        const today = new Date();
        datePicker.value = today.toISOString().split("T")[0];
        updateFormattedDate();
    });

    document.addEventListener("click", (e) => {
        if (e.target.closest('.div_popup') == null && e.target.closest('.div_event') == null && e.target.closest('.div_add_event') == null && e.target.closest('.div_popup_add_event') == null) {
            close_event();
            close_event_div_add_event();
        }
    });
    document.addEventListener("wheel", (e) => {
        close_event();
        close_event_div_add_event();

    });
    // Mettre à jour lors du changement manuel
    datePicker.addEventListener("change", updateFormattedDate);


    //     "agenda": {
    //         "2025-01-13": [
    //             {
    //                 "id": "1",
    //                 "title": "Mathématiques",
    //                 "startTime": "08:00",
    //                 "endTime": "10:00",
    //                 "group": "Maths",
    //                 "color": "red",
    //                 "linkedItems": {
    //                     "notes": ["note1", "note2"],
    //                     "sections": ["section1", "section2"]
    //                 },
    //                 "location": "Salle A101",
    //                 "description": "Cours sur les intégrales"
    //             },
    //             {
    //                 "id": "2",
    //                 "title": "Philosophie",
    //                 "startTime": "9:30",
    //                 "endTime": "12:00",
    //                 "group": "Philo",
    //                 "color": "blue",
    //                 "linkedItems": {
    //                     "notes": ["note3"],
    //                     "sections": ["section3"]
    //                 },
    //                 "location": "Salle B202",
    //                 "description": "Débat sur la liberté"
    //             },
    //             {
    //                 "id": "3",
    //                 "title": "Histoire",
    //                 "startTime": "8:30",
    //                 "endTime": "13:00",
    //                 "color": "green",
    //                 "linkedItems": {
    //                     "notes": ["note3"],
    //                     "sections": ["section3"]
    //                 },
    //                 "description": "Débat sur la liberté"
    //             }
    //         ],
    //         "2025-01-18": [
    //             {
    //                 "id": "3",
    //                 "title": "Physique",
    //                 "startTime": "09:00",
    //                 "endTime": "11:00",
    //                 "group": "Physique",
    //                 "color": "red",
    //                 "linkedItems": {
    //                     "notes": ["note4"],
    //                     "sections": []
    //                 },
    //                 "location": "Laboratoire",
    //                 "description": "Travaux pratiques sur l'électricité"
    //             }
    //         ]
    //     }
    // }

    // Initialiser la date à aujourd'hui
    const today = new Date();
    datePicker.value = today.toISOString().split("T")[0];
    updateFormattedDate();


    async function get_agenda() {
        let response = await fetch('agenda/agenda_events');
        let data = await response.json();
        console.log(data);
        return data;
    }

</script>

</html>